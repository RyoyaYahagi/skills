---
description: リポジトリ運用エージェント - git操作・CI・PR作成ポリシー。「コミット」「commit」「プッシュ」「push」「PR作成」「プルリク」「マージ」「merge」「デプロイ」「deploy」のキーワードで自動適用。
---

# リポジトリ運用ポリシー

**このファイルは以下のキーワードが含まれる指示を受けた場合に自動で読み込まれます:**
- 「コミット」「commit」「プッシュ」「push」「PR作成」「プルリク」「マージ」「merge」「デプロイ」「deploy」

このワークフローは、git操作・CI実行・PR作成を自動化し、**PRのレビューとmainへのマージは必ず人が行う**ポリシーに従います。

---

## リポジトリ情報
- リポジトリURL: （自動検出: `git remote get-url origin`）
- デフォルトベースブランチ: develop（または main）
- テストコマンド: `npm run build` / `npm test` / `pytest` / `make test`（プロジェクトに応じて）
- Lintコマンド: `npm run lint` / `flake8`（未設定の場合はスキップ）

---

## 開発フロー（概要）

### 1. Issue作成（人間）
- 要件/タスクを人間がIssueとして作成

### 2. ブランチ作成（自動）
- 命名規則: `<type>/<ISSUE番号>-short-desc`
- type: `feature` | `fix` | `chore` | `hotfix` | `refactor`
- 例: `feature/ISSUE-123-add-login`, `fix/ISSUE-456-api-error`
- エージェントがベースブランチを確認して作成

### 2.5 タスク別Worktree設定（自動）
- `scripts/auto-worktree.sh [type] [description] [issue-number]` を実行
- 既存worktreeがあれば再利用し、なければ `../wt/<repo名>/<branch>` に自動作成
- 実装・テスト・コミットは必ず対象worktreeで実施

### 3. 実装・小刻みコミット（自動）
- エージェントが作業単位でコミット（Conventional Commits準拠）
- コミット例: `feat(auth): add OAuth login (#123)`
- **設計変更・重大リファクタは事前に人へ通知**

### 4. ローカルテスト・CI実行（自動）
- 指定テストコマンドを実行
- **CIがパスするまでマージ不可**

### 5. push & PR作成（自動、マージは保留）
- main/master以外のブランチへpush（自動）
- PR本文はテンプレートに従って自動生成（`scripts/pr.sh`）
- **PRを作るまでは自動、マージは人間の確認後のみ**

### 6. レビュー（人間）
- レビュワーがapproveしたら、人間がマージ

### 7. リリース（人間 or 自動化ルール）
- mainへのマージ後にタグ付け・リリース

---

## 自動ブランチ・コミットトリガー

### ブランチ作成タイミング
以下の条件を満たしたら、新しいブランチを作成する：

1. **新しいタスク開始時**
   - 新しい機能、修正、リファクタリングの着手時
   - 現在のブランチがmain/master/developの場合は必須

2. **異なるスコープの変更時**
   - 現在の作業と異なるスコープ（異なるIssue番号など）の変更を開始する場合

### Worktree作成タイミング
以下の条件を満たしたら、タスク用worktreeを作成または再利用する：
1. **新しいタスク開始時**
   - ブランチ決定直後に `scripts/auto-worktree.sh` を実行
2. **並行開発開始時**
   - 既存タスクと同時進行する場合、必ず別worktreeを使う
3. **既存タスク再開時**
   - `git worktree list` で対象ブランチのworktreeを探索し再利用する

### スレッド分離タイミング
以下の条件を満たしたら、会話スレッドを分離して進行する：
1. **並行タスク開始時**
   - worktreeを新規作成したタイミングで、新しい会話スレッドへ切り替える
2. **別Issueへ切替時**
   - 異なるIssue番号のタスクへ移る場合、必ず別スレッドにする
3. **再開時**
   - 既存worktreeを再利用する場合も、対応する既存スレッドを使う

注記:
- エージェントは会話スレッドを自動生成できないため、人間が作成する
- 自動生成不可の場合、エージェントは「推奨スレッド名」と「対象worktreeパス」を提示する

### コミットタイミング
以下のタイミングで自動コミットを行う：

1. **論理的な区切り**
   - 1つの機能/修正が完了した時
   - ファイル追加/削除/リネームが完了した時
   - テストが通る状態になった時

2. **作業の中断時**
   - 別のタスクに切り替える前
   - ユーザーからのフィードバック待ち前

3. **制限値超過前**
   - 変更行数が200行を超えそうな時（300行制限の前に分割）

### ブランチ名自動生成

#### Issue番号がある場合
`<type>/<ISSUE番号>-<short-desc>`

#### Issue番号がない場合
`<type>/<YYYYMMDD>-<short-desc>`

#### type判定ロジック
| 変更内容                         | type       |
| -------------------------------- | ---------- |
| 新機能追加                       | `feature`  |
| バグ修正                         | `fix`      |
| リファクタリング（機能変更なし） | `refactor` |
| ドキュメント更新                 | `docs`     |
| テスト追加・修正                 | `test`     |
| ビルド・CI設定                   | `chore`    |
| 緊急修正                         | `hotfix`   |

---

## 機能分離ポリシー（重要）

### 問題: 複数機能の混在
異なる機能を同じブランチで開発すると、以下の問題が発生する：
- 分離が困難になる（例: CloudKitとバーコードスキャナーの混在）
- ロールバックが複雑になる
- レビューが困難になる

### 解決策

#### 1. 1機能 = 1ブランチ（厳守）
```bash
# 悪い例: 1ブランチで複数機能
feature/20260208-misc-improvements  # ❌

# 良い例: 機能ごとにブランチ
feature/20260208-cloudkit-sync      # ✅
feature/20260208-barcode-scanner    # ✅
```

#### 2. マイルストーンコミット
以下のタイミングで**必ず**コミットする：
- 新しいファイル作成後
- 1機能の実装完了時
- **ビルド成功時**（これが最低限の基準）
- 別の機能に着手する前

#### 3. Git Worktreeの自動活用（並行開発時）
複数機能を並行で開発する場合は `scripts/auto-worktree.sh` を使用：
```bash
# 例: feature/123-login のworktreeを作成/再利用
./scripts/auto-worktree.sh feature "login" 123

# 出力されたパスへ移動して作業
cd ../wt/<repo名>/feature-123-login
```

**Worktreeのメリット:**
- 互いに干渉しない
- ブランチ切り替え不要
- stash忘れによる混在を防止

#### 4. Stashルール
ブランチ切り替え前に**必ず**以下を確認：
```bash
# 未コミットの変更を確認
git status

# 変更がある場合は退避
git stash push -m "feature-name-wip"

# 復元時
git stash pop
```

#### 5. 機能開始チェックリスト
新機能の開発を開始する前に：
- [ ] 現在のブランチを確認（`git branch --show-current`）
- [ ] 未コミットの変更がないか確認（`git status`）
- [ ] 新しい機能ブランチとworktreeを作成（`./scripts/auto-worktree.sh ...`）
- [ ] 既存の別機能の変更がないか確認

---

## 命名規約

### ブランチ名
```
<type>/<ISSUE番号>-short-desc
```
- type: `feature` | `fix` | `chore` | `hotfix` | `refactor`

### コミットメッセージ（Conventional Commits）
```
<type>(<scope>): <description> (#ISSUE)
```
- 例: `feat(auth): add OAuth login (#123)`
- 例: `fix(api): correct 500 on /users (#456)`

---

## 自動化ルール

### 自動実行OK（AIが実行）
1. **ブランチ確認・作成**:
     - 現在の変更が新しい機能/タスクの場合、必ず新ブランチを作成して移動する
     - 誤ったブランチ（develop/mainなど）にいる場合、変更を持ったまま適切なブランチへ切り替える (`git switch -c new-branch`)
2. `scripts/auto-worktree.sh` によるタスク別worktreeの作成/再利用
3. ブランチの命名（`<type>/...`）
4. 小さな変更のコミット（Conventional Commits準拠）
5. `git push origin <branch>`（main/master以外）
6. テスト実行、静的解析（linters）の実行
7. PRの作成（`scripts/pr.sh` 使用、マージはしない）
8. PR説明文・変更点の要約生成
9. 軽微なconflict解消（事前ポリシーで許可した場合のみ、解消案をPRに記載）
10. CIログの取得と要約
11. 自動実行ログをPRに添付

### 必ず人が行う（自動化しない）
- **PRの最終レビュー & 承認**
- **main/masterへのマージ**（自動マージは不可）
- 設計やAPIなどの重大な方針変更の判断
- セキュリティ影響の高い変更の承認

---

## 実務ルール（AIが守る）

1. **絶対に直接 main/master に push しない**。すべて feature/* へ。
2. **PRはCIがgreenにならない限りレビュー依頼しない**（作成はOK、レビュー依頼はCI pass後）
3. コミットメッセージは **Conventional Commits準拠**
4. 1コミットの最大行数変更は **300行まで**（大きい変更は分割提案）
5. PR作成時に **自動でチェックリストを入れる**
6. 必要なテストがある場合は **必ず追加**
7. **自動実行ログ**を常にPRに添付（コマンド + 出力の要約）
8. コミットには `--signoff` を付ける
9. **コンテキスト確認**: 作業開始前に必ず `git branch --show-current` でブランチを確認する
10. **タスク分離**: 異なるタスク/Issueに取り組む際は、必ず新しいブランチを作成するか適切なブランチに切り替える
11. **変更退避**: ブランチ切り替え時に未コミットの変更がある場合は、`git stash` で退避するかコミットする
12. **スレッド分離**: 並行タスク時は worktree ごとに会話スレッドを分離する（1タスク=1worktree=1スレッド）
13. **明示ルール**: 同一スレッドで複数worktreeを扱う場合、各応答の先頭で対象 `worktree path` と `branch` を明示する

---

## PR作成時のチェック基準

- [ ] テスト/ビルドコマンドが exit 0
- [ ] Lintが exit 0（設定されている場合）
- [ ] 変更が1つの目的にまとまっている
- [ ] 大きすぎる変更は分割案を提示
- [ ] セキュリティ影響がないか確認

---

## PRテンプレート（`pr.sh` が自動生成）

```markdown
## 概要
[変更の1行サマリ]

## 変更内容
- コミット1
- コミット2

## 差分ハイライト
[変更ファイル統計]

## 自動実行ログ
- 実行コマンド一覧
- テスト/ビルド結果

## 動作確認手順
- [ ] ローカルで動作確認済み
- [ ] 本番環境で確認済み

## チェックリスト
- [ ] テスト/ビルドが通っている
- [ ] 変更が1つの目的にまとまっている
- [ ] セキュリティに影響する変更はない
- [ ] 必要なテストを追加した
```

---

## エラー発生時の動作

- **テスト/CIが失敗した場合**: マージ要求は行わず、失敗ログと再現手順を記載した報告を作成
- **競合が解消できない場合**: 変更のスナップショットと解決提案を人に提示して停止
- **重大な判断が必要な場合**: 必ず人に確認を求めて停止

---

## 出力フォーマット（人に提示する要約）

```
## 1行サマリ
[何をしたか]（例: Created branch feature/ISSUE-123-add-login and pushed 3 commits）

## 実行コマンド一覧
- git add .
- git commit -m "..."
- git push origin develop

## コンテキスト
- thread: [推奨スレッド名 or 現在スレッド]
- worktree: [対象worktreeの絶対パス]
- branch: [対象ブランチ名]

## テスト/ビルド結果
- npm run build: ✅ 成功 / ❌ 失敗

## PRリンク
[自動生成されたPRのURL]

## 次の推奨アクション
- [ ] PRの内容を確認
- [ ] `gh pr merge --squash` でマージ
```
